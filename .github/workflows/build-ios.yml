name: Build SwiftUI App for IPA

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Create temp Xcode project
      run: |
        mkdir ScoreKeeper
        cd ScoreKeeper
        swift package init --type executable
        echo 'import SwiftUI\nimport UIKit\n@main\nstruct ScoreApp: App { var body: some Scene { WindowGroup { ContentView() } } }' > Sources/ScoreKeeper/main.swift
        mkdir Sources/ScoreKeeper/Views
        cp ../ContentView.swift Sources/ScoreKeeper/Views/
        mkdir Resources
        cp ../Info.plist Resources/
        xcodebuild -create-xcframework

    - name: Build for iPhone
      run: |
        xcodebuild archive \
          -scheme ScoreKeeper \
          -sdk iphoneos \
          -archivePath ${{ github.workspace }}/ScoreKeeper.xcarchive

        xcodebuild -exportArchive \
          -archivePath ${{ github.workspace }}/ScoreKeeper.xcarchive \
          -exportPath ${{ github.workspace }}/ipa \
          -exportOptionsPlist ../ExportOptions.plist

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: ScoreKeeper.ipa
        path: ipa/ScoreKeeper.ipa
